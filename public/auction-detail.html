<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wireless Earbuds Pro - Launchbid</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#10B981',
            accent: '#8B5CF6',
            dark: '#1E293B',
            light: '#F8FAFC'
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
        },
      },
    }
  </script>
  <!-- Inter Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <!-- Main CSS -->
  <link rel="stylesheet" href="css/main.css" />
  <!-- Custom CSS for Bid History -->
  <style>
    /* Bid history container displays new bids at the top */
    #bidHistoryList {
      display: flex;
      flex-direction: column-reverse;
      gap: 0.5rem;
    }

    .bid-entry {
      transition: opacity 0.5s ease-in-out;
    }

    /* Winner banner animation */
    .winner-banner {
      animation: fadeIn 1s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
  </style>
</head>

<body class="bg-gray-100">
  <!-- Header -->
  <header class="bg-white px-8 py-4 border-b border-gray-100 flex justify-between items-center">
    <div class="flex items-center">
      <a href="index.html" class="text-2xl font-bold text-primary mr-2">Launchbid</a>
      <div class="bg-blue-100 text-primary text-xs px-2 py-1 rounded-full">BETA</div>
    </div>
    <nav class="hidden md:flex space-x-6">
      <a href="auctions.html" class="text-black font-medium">Auctions</a>
      <a href="equity.html" class="text-black opacity-70 hover:opacity-100">Equity</a>
      <a href="loans.html" class="text-black opacity-70 hover:opacity-100">Loans</a>
      <a href="dashboard.html" class="text-black opacity-70 hover:opacity-100">Dashboard</a>
    </nav>
    <div class="flex items-center space-x-4">
      <div class="relative">
        <i class="material-icons" style="font-size: 20px;">shopping_bag</i>
        <span
          class="absolute -top-1 -right-1 bg-primary text-white text-xs w-4 h-4 rounded-full flex items-center justify-center">2</span>
      </div>
      <div class="relative">
        <i class="material-icons" style="font-size: 20px;">notifications</i>
        <span
          class="absolute -top-1 -right-1 bg-primary text-white text-xs w-4 h-4 rounded-full flex items-center justify-center">5</span>
      </div>
      <div class="flex items-center">
        <img src="https://images.unsplash.com/photo-1568602471122-7832951cc4c5?ixlib=rb-1.2.1&auto=format&fit=crop&w=120&q=80"
          alt="Profile" class="w-8 h-8 rounded-full" />
        <span class="ml-2 text-black">Alex</span>
      </div>
    </div>
  </header>

  <!-- Connect/Disconnect Wallet Section -->
  <div class="p-4 bg-gray-50 rounded-xl my-4 flex items-center">
    <button id="connectWalletBtn" class="py-2 px-4 bg-green-500 rounded text-white mr-4">
      Connect Wallet
    </button>
    <button id="disconnectWalletBtn" class="py-2 px-4 bg-red-500 rounded text-white mr-4" style="display: none;">
      Disconnect Wallet
    </button>
    <button id="reselectWalletBtn" class="py-2 px-4 bg-blue-500 rounded text-white mr-4" style="display: none;">
      Reselect Wallet
    </button>
    <span id="walletAddressDisplay" class="text-black font-medium"></span>
  </div>

  <!-- Auction Timer Section (Universal Timer updated via Socket.IO) -->
  <div class="p-4 bg-gray-50 rounded-xl my-4 text-center">
    <div id="timerDisplay" class="text-4xl font-bold text-red-500">Time Remaining: 30s</div>
  </div>

  <!-- Main Auction Content -->
  <div class="flex h-full bg-white">
    <!-- Left Section: Product Details -->
    <div class="w-2/3 p-8">
      <div class="flex items-center mb-6">
        <a href="auctions.html" class="mr-4 flex items-center text-black opacity-70">
          <i class="material-icons mr-1" style="font-size: 18px;">arrow_back</i>
          Back to Auctions
        </a>
        <span class="text-xs bg-blue-100 text-primary px-2 py-1 rounded-full">TECH</span>
      </div>

      <div class="flex mb-8">
        <div class="w-1/2 pr-8">
          <div class="w-full h-80 rounded-xl overflow-hidden mb-4">
            <img src="https://images.unsplash.com/photo-1590658268037-6bf12165a8df?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80"
              alt="Wireless Earbuds Pro" class="w-full h-full object-cover" />
          </div>
          <div class="grid grid-cols-4 gap-2">
            <div class="cursor-pointer rounded-lg overflow-hidden border-2 border-primary">
              <img src="https://images.unsplash.com/photo-1590658268037-6bf12165a8df?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80"
                alt="Earbuds thumbnail" class="w-full h-16 object-cover" />
            </div>
            <div class="cursor-pointer rounded-lg overflow-hidden border border-gray-200">
              <img src="https://images.unsplash.com/photo-1606220588913-b3aacb4d2f46?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80"
                alt="Earbuds thumbnail" class="w-full h-16 object-cover" />
            </div>
            <div class="cursor-pointer rounded-lg overflow-hidden border border-gray-200">
              <img src="https://images.unsplash.com/photo-1584670747947-3dc98b4c7ca2?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80"
                alt="Earbuds thumbnail" class="w-full h-16 object-cover" />
            </div>
            <div class="cursor-pointer rounded-lg overflow-hidden border border-gray-200 flex items-center justify-center bg-gray-100">
              <i class="material-icons text-gray-400">play_circle_filled</i>
            </div>
          </div>
        </div>

        <div class="w-1/2">
          <div class="flex items-center mb-4">
            <!-- Dynamically show bid count -->
            <span class="bg-red-500 text-white text-xs px-2 py-1 rounded-full flex items-center mr-2">
              <i class="material-icons mr-1" style="font-size: 12px;">schedule</i>
              Ending Soon
            </span>
            <span id="bidCount" class="bg-purple-100 text-accent text-xs px-2 py-1 rounded-full">0 bids</span>
          </div>

          <h1 class="text-3xl font-bold text-black mb-2">Wireless Earbuds Pro</h1>
          <div class="flex items-center mb-4">
            <div class="flex items-center mr-4">
              <span class="text-yellow-400 mr-1">★★★★★</span>
              <span class="text-black opacity-70 text-sm">4.9</span>
            </div>
            <span class="text-black opacity-70 text-sm">By <span class="text-black font-medium">SoundCore Tech</span></span>
          </div>

          <p class="text-black opacity-70 mb-6">
            Premium noise-canceling earbuds with spatial audio and adaptive EQ. Industry-leading battery life of up to 30 hours with the charging case. Water and sweat resistant for all your adventures.
          </p>

          <div class="bg-gray-50 rounded-xl p-4 mb-6">
            <div class="flex items-center justify-between mb-3">
              <div class="text-black opacity-70">Retail Price</div>
              <div class="text-black font-semibold">$179.99</div>
            </div>
            <div class="flex items-center justify-between">
              <div class="text-primary font-medium">Current Bid</div>
              <!-- Display current bid in USDT and its ETH equivalent -->
              <div id="currentBid" class="text-2xl font-bold text-black">$5.00 USDT / 0.00250 ETH</div>
            </div>
            <div class="text-right text-black opacity-60 text-xs mt-1">Initial bid</div>
          </div>

          <!-- Place Bid Section (Auto-increment by 0.10 USDT per click) -->
          <div class="flex space-x-3">
            <button id="placeBidBtn" class="flex-1 py-3 bg-primary rounded-xl text-white font-medium">
              <i class="material-icons mr-2" style="vertical-align: middle;">gavel</i>
              Place Bid (will bid $5.10)
            </button>
          </div>
        </div>
      </div>

      <div class="mb-8">
        <h2 class="text-xl font-bold text-black mb-4">Product Details</h2>
        <div class="grid grid-cols-2 gap-6">
          <div class="bg-gray-50 p-4 rounded-xl">
            <div class="flex items-center mb-3">
              <i class="material-icons text-primary mr-2">sensors</i>
              <h3 class="font-medium text-black">Active Noise Cancellation</h3>
            </div>
            <p class="text-black opacity-70 text-sm">Industry-leading noise cancellation adapts to your environment in real-time.</p>
          </div>
          <div class="bg-gray-50 p-4 rounded-xl">
            <div class="flex items-center mb-3">
              <i class="material-icons text-primary mr-2">battery_full</i>
              <h3 class="font-medium text-black">Battery Life</h3>
            </div>
            <p class="text-black opacity-70 text-sm">Up to 8 hours of listening time, 30 hours with charging case.</p>
          </div>
          <div class="bg-gray-50 p-4 rounded-xl">
            <div class="flex items-center mb-3">
              <i class="material-icons text-primary mr-2">water_drop</i>
              <h3 class="font-medium text-black">Water Resistance</h3>
            </div>
            <p class="text-black opacity-70 text-sm">IPX4 rated for sweat and water resistance during workouts or in light rain.</p>
          </div>
          <div class="bg-gray-50 p-4 rounded-xl">
            <div class="flex items-center mb-3">
              <i class="material-icons text-primary mr-2">surround_sound</i>
              <h3 class="font-medium text-black">Spatial Audio</h3>
            </div>
            <p class="text-black opacity-70 text-sm">Dynamic head tracking for an immersive, theater-like sound experience.</p>
          </div>
        </div>
      </div>

      <div>
        <h2 class="text-xl font-bold text-black mb-4">About the Startup</h2>
        <div class="flex">
          <img src="https://images.unsplash.com/photo-1560179707-f14e90ef3623?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80"
            alt="SoundCore Office" class="w-16 h-16 rounded-xl object-cover mr-4" />
          <div>
            <h3 class="font-medium text-black">SoundCore Tech</h3>
            <p class="text-black opacity-70 text-sm mb-2">Founded in 2021 • San Francisco, CA</p>
            <p class="text-black opacity-70 text-sm">SoundCore Tech is redefining audio experiences with their innovative approach to sound engineering and sustainable manufacturing.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Sidebar: Bid History & Related Auctions -->
    <div class="w-1/3 border-l border-gray-100 p-8">
      <div class="mb-8">
        <h2 class="text-xl font-bold text-black mb-4">Bid History</h2>
        <!-- Bid history list container; new bids appear at the top via CSS -->
        <div id="bidHistoryList" class="max-h-80 overflow-y-auto pr-2">
          <!-- Initial bid entry -->
          <div class="bid-entry flex items-center justify-between py-3 border-b border-gray-100">
            <div class="flex items-center">
              <img src="https://via.placeholder.com/32" alt="Initial" class="w-8 h-8 rounded-full mr-3" />
              <div class="text-black">Initial Bid</div>
            </div>
            <div class="text-right">
              <div class="font-medium text-black">$5.00 USDT / 0.00250 ETH</div>
            </div>
          </div>
        </div>
      </div>

      <div>
        <h2 class="text-xl font-bold text-black mb-4">Related Auctions</h2>
        <div class="space-y-4">
          <div class="flex rounded-xl overflow-hidden shadow-sm border border-gray-100">
            <img src="https://images.unsplash.com/photo-1547949003-9792a18a2601?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80" alt="Portable Speaker" class="w-20 h-20 object-cover" />
            <div class="p-3 flex-1">
              <h3 class="text-black font-medium">Portable Bluetooth Speaker</h3>
              <div class="flex justify-between mt-1">
                <div class="text-primary font-medium">$9.64</div>
                <div class="text-black opacity-60 text-xs">04:23:59</div>
              </div>
            </div>
          </div>
          <div class="flex rounded-xl overflow-hidden shadow-sm border border-gray-100">
            <img src="https://images.unsplash.com/photo-1575311373937-040b8e1fd6b0?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80" alt="Fitness Tracker" class="w-20 h-20 object-cover" />
            <div class="p-3 flex-1">
              <h3 class="text-black font-medium">Smart Fitness Tracker</h3>
              <div class="flex justify-between mt-1">
                <div class="text-primary font-medium">$8.75</div>
                <div class="text-black opacity-60 text-xs">03:45:01</div>
              </div>
            </div>
          </div>
          <div class="flex rounded-xl overflow-hidden shadow-sm border border-gray-100">
            <img src="https://images.unsplash.com/photo-1517231925375-bf2cb42917a5?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80" alt="Smart Coffee Maker" class="w-20 h-20 object-cover" />
            <div class="p-3 flex-1">
              <h3 class="text-black font-medium">Smart Coffee Maker</h3>
              <div class="flex justify-between mt-1">
                <div class="text-primary font-medium">$5.42</div>
                <div class="text-black opacity-60 text-xs">05:12:37</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white py-10">
    <div class="container mx-auto px-8">
      <div class="grid grid-cols-4 gap-8">
        <div>
          <h3 class="text-xl font-bold mb-4">Launchbid</h3>
          <p class="text-gray-400 text-sm">Connecting startups with early supporters through innovative funding mechanisms.</p>
          <div class="flex mt-4 space-x-4">
            <a href="#" class="text-gray-400 hover:text-white">
              <i class="material-icons">facebook</i>
            </a>
            <a href="#" class="text-gray-400 hover:text-white">
              <i class="material-icons">public</i>
            </a>
            <a href="#" class="text-gray-400 hover:text-white">
              <i class="material-icons">insert_link</i>
            </a>
          </div>
        </div>
        <div>
          <h4 class="font-medium mb-4">Explore</h4>
          <ul class="space-y-2 text-gray-400">
            <li><a href="auctions.html" class="hover:text-white">Auctions</a></li>
            <li><a href="equity.html" class="hover:text-white">Equity Offerings</a></li>
            <li><a href="loans.html" class="hover:text-white">Microloans</a></li>
            <li><a href="#" class="hover:text-white">How It Works</a></li>
          </ul>
        </div>
        <div>
          <h4 class="font-medium mb-4">Company</h4>
          <ul class="space-y-2 text-gray-400">
            <li><a href="#" class="hover:text-white">About Us</a></li>
            <li><a href="#" class="hover:text-white">Careers</a></li>
            <li><a href="#" class="hover:text-white">Blog</a></li>
            <li><a href="#" class="hover:text-white">Contact</a></li>
          </ul>
        </div>
        <div>
          <h4 class="font-medium mb-4">Legal</h4>
          <ul class="space-y-2 text-gray-400">
            <li><a href="#" class="hover:text-white">Terms of Service</a></li>
            <li><a href="#" class="hover:text-white">Privacy Policy</a></li>
            <li><a href="#" class="hover:text-white">Cookie Policy</a></li>
            <li><a href="#" class="hover:text-white">Compliance</a></li>
          </ul>
        </div>
      </div>
      <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400 text-sm">
        <p>&copy; 2025 Launchbid. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- JavaScript Libraries -->
  <script src="js/main.js"></script>
  <script src="js/auction-detail.js"></script>
  <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- Socket.IO Timer Updates -->
  <script>
    const socket = io();

    socket.on('timerUpdate', function (data) {
      const timerDisplay = document.getElementById('timerDisplay');
      timerDisplay.textContent = `Time Remaining: ${data.timeRemaining}s`;
    });

    socket.on('auctionEnded', function (data) {
      const timerDisplay = document.getElementById('timerDisplay');
      timerDisplay.innerHTML = `<div class="winner-banner text-4xl font-bold text-green-600">Auction Ended!</div><div class="text-2xl text-blue-600">Winner: ${data.winner}</div>`;
    });
  </script>

  <!-- Wallet Connection and Bid Placement Scripts -->
  <script>
    // Global variables for current bid and bid count (synchronized via Socket.IO)
    let currentBid = 5.00; // starting bid in USDT
    let bidCounter = 1;

    // Update display functions
    function updateCurrentBidDisplay(usdt) {
      const ethEquivalent = (usdt * 0.0005).toFixed(5);
      document.getElementById('currentBid').textContent = `$${usdt.toFixed(2)} USDT / ${ethEquivalent} ETH`;
    }

    // Set initial displays
    updateCurrentBidDisplay(currentBid);
    document.getElementById('bidCount').textContent = `${bidCounter} bid${bidCounter > 1 ? "s" : ""}`;
    // Update the Place Bid button to show the next bid amount (current bid + 0.10)
    document.getElementById('placeBidBtn').innerText = `Place Bid (will bid $${(currentBid + 0.10).toFixed(2)})`;

    // Connect Wallet
    document.getElementById('connectWalletBtn').addEventListener('click', async function () {
      if (window.ethereum) {
        try {
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          const walletAddress = accounts[0];
          document.getElementById('walletAddressDisplay').textContent = "Connected: " + walletAddress;
          window.currentWallet = walletAddress;
        } catch (error) {
          console.error('User denied account access', error);
        }
      } else {
        alert("Please install MetaMask to use this feature.");
      }
    });

    // Place Bid using MetaMask and ethers.js
    async function placeBid() {
      if (!window.currentWallet) {
        alert("Please connect your wallet first.");
        return;
      }
      // Calculate the new bid: next bid = currentBid + 0.10 USDT
      const newBid = currentBid + 0.10;
      // Compute the ETH equivalent for the full new bid amount
      const bidFeeEth = (newBid * 0.0005).toFixed(6);
      const companyWallet = "0x4b19581c2bA3e781f834b25C11D81A590AfACEA4"; // Company wallet

      try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const tx = {
          from: window.currentWallet,
          to: companyWallet,
          value: ethers.utils.parseEther(bidFeeEth)
        };
        const transactionResponse = await signer.sendTransaction(tx);
        console.log("Transaction sent:", transactionResponse.hash);
        alert("Bid placed! Transaction hash: " + transactionResponse.hash);
        // Notify backend of the bid (backend increments bid by 0.10 USDT)
        await fetch('/api/placeBid', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            bidAmount: 0.10,  // fixed increment (the backend uses this to update the state)
            bidderWallet: window.currentWallet,
            txHash: transactionResponse.hash
          })
        });
      } catch (error) {
        console.error("Error sending transaction:", error);
        alert("Error placing bid. Please try again.");
      }
    }
    document.getElementById('placeBidBtn').addEventListener('click', placeBid);

    // Socket.IO: Listen for new bid events
    socket.on('newBid', function (data) {
      console.log('New bid:', data);
      // Update global state based on server broadcast
      currentBid = data.newBidPrice;
      bidCounter = data.bidCount;
      updateCurrentBidDisplay(currentBid);
      document.getElementById('bidCount').textContent = `${bidCounter} bids`;
      // Update the Place Bid button to show the next bid (current bid + 0.10)
      document.getElementById('placeBidBtn').innerText = `Place Bid (will bid $${(currentBid + 0.10).toFixed(2)})`;
      // Append new bid entry to history
      const now = new Date();
      const timeString = now.getHours() + ":" + now.getMinutes().toString().padStart(2, '0');
      appendBidHistory({ bidderWallet: data.bidderWallet || "Anonymous", newBid: currentBid, time: timeString });
      // Add extra time to the universal timer via a global function (defined by the server timer)
      if (typeof window.addExtraTime === "function") {
        window.addExtraTime(5);
      }
      // Remember the last bidder for the winner announcement later
      window.lastBidder = data.bidderWallet;
    });

    // Function to append new bid entries to the bid history
    function appendBidHistory(bidInfo) {
      const historyList = document.getElementById('bidHistoryList');
      const entry = document.createElement('div');
      entry.className = "bid-entry flex items-center justify-between py-3 border-b border-gray-100 opacity-0 transition-opacity duration-500";
      entry.innerHTML = `
        <div class="flex items-center">
          <img src="https://via.placeholder.com/32" alt="Bidder" class="w-8 h-8 rounded-full mr-3" />
          <div class="text-black">${bidInfo.bidderWallet}</div>
        </div>
        <div class="text-right">
          <div class="font-medium text-black">$${bidInfo.newBid.toFixed(2)} USDT / ${(bidInfo.newBid * 0.0005).toFixed(5)} ETH</div>
          <div class="text-black opacity-60 text-xs">${bidInfo.time}</div>
        </div>
      `;
      historyList.appendChild(entry);
      setTimeout(() => { entry.style.opacity = 1; }, 50);
    }
  </script>

  <!-- Socket.IO for Real-Time Timer and Auction End Notifications (if using a server-side timer) -->
  <script>
    socket.on('timerUpdate', function(data) {
      const timerDisplay = document.getElementById('timerDisplay');
      timerDisplay.textContent = `Time Remaining: ${data.timeRemaining}s`;
    });

    socket.on('auctionEnded', function(data) {
      const timerDisplay = document.getElementById('timerDisplay');
      timerDisplay.innerHTML = `<div class="winner-banner text-4xl font-bold text-green-600">Auction Ended!</div><div class="text-2xl text-blue-600">Winner: ${data.winner}</div>`;
    });
  </script>
</body>

</html>
